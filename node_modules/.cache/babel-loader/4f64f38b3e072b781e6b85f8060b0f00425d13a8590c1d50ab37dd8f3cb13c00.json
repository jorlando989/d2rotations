{"ast":null,"code":"import _createForOfIteratorHelper from \"C:/Users/jorla/Documents/d2rotations/my-app/node_modules/@babel/runtime/helpers/esm/createForOfIteratorHelper.js\";\nimport _regeneratorRuntime from \"C:/Users/jorla/Documents/d2rotations/my-app/node_modules/@babel/runtime/helpers/esm/regeneratorRuntime.js\";\nimport _asyncToGenerator from \"C:/Users/jorla/Documents/d2rotations/my-app/node_modules/@babel/runtime/helpers/esm/asyncToGenerator.js\";\nimport { allManifest, compareVersionNumbers, loadedVersion, loadManifestFromApiWithoutCheckingCache, vlog, isVerbose } from '@d2api/manifest';\nexport { getDef, getAllDefs, setApiKey, setLanguage, allManifest, includeTables, excludeTables, verbose, defLanguages } from '@d2api/manifest';\nexport * from '@d2api/manifest/generated-funcs.js';\nimport { createStore, get as idbGet, keys as idbKeys, set as idbSet, del as idbDel } from 'idb-keyval';\nvar manifestStore = createStore('manifestDb', 'manifestStore');\n/**\r\n * check keys in indexeddb, find the highest numbered one\r\n */\nexport function getLatestCachedVersion(_x) {\n  return _getLatestCachedVersion.apply(this, arguments);\n}\n/**\r\n * loads the newest manifest according to what version the API advertises\r\n *\r\n * if the newest version is already cached locally, uses that. otherwise\r\n * downloads the manifest file from the internet\r\n */\nfunction _getLatestCachedVersion() {\n  _getLatestCachedVersion = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime().mark(function _callee(lang) {\n    var _a, sep, keysInCache, manifestsByVersion;\n    return _regeneratorRuntime().wrap(function _callee$(_context) {\n      while (1) switch (_context.prev = _context.next) {\n        case 0:\n          sep = \"__\".concat(lang, \"__\");\n          _context.next = 3;\n          return idbKeys(manifestStore);\n        case 3:\n          keysInCache = _context.sent;\n          manifestsByVersion = keysInCache.filter(function (p) {\n            return p.includes(sep);\n          }).sort(compareVersionNumbers);\n          return _context.abrupt(\"return\", ((_a = manifestsByVersion[0]) === null || _a === void 0 ? void 0 : _a.split(sep)[0]) || '');\n        case 6:\n        case \"end\":\n          return _context.stop();\n      }\n    }, _callee);\n  }));\n  return _getLatestCachedVersion.apply(this, arguments);\n}\nexport function loadDefs() {\n  return _loadDefs.apply(this, arguments);\n}\n/**\r\n * saves the loaded manifest to indexeddb file\r\n */\nfunction _loadDefs() {\n  _loadDefs = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime().mark(function _callee2() {\n    return _regeneratorRuntime().wrap(function _callee2$(_context2) {\n      while (1) switch (_context2.prev = _context2.next) {\n        case 0:\n          isVerbose && console.time('manifest loaded');\n          _context2.next = 3;\n          return loadManifestFromApiWithoutCheckingCache(function (params) {\n            return idbGet(\"\".concat(params.version, \"__\").concat(params.language, \"__\").concat(params.tableName), manifestStore);\n          });\n        case 3:\n          isVerbose && console.timeEnd('manifest loaded');\n          // save the results for next time\n          save();\n        case 5:\n        case \"end\":\n          return _context2.stop();\n      }\n    }, _callee2);\n  }));\n  return _loadDefs.apply(this, arguments);\n}\nfunction save() {\n  return _save.apply(this, arguments);\n}\nfunction _save() {\n  _save = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime().mark(function _callee4() {\n    var componentName;\n    return _regeneratorRuntime().wrap(function _callee4$(_context4) {\n      while (1) switch (_context4.prev = _context4.next) {\n        case 0:\n          vlog(\"saving manifest to indexeddb\");\n          if (allManifest) {\n            _context4.next = 4;\n            break;\n          }\n          console.error(\"tried to save manifest but none was loaded in memory?\");\n          return _context4.abrupt(\"return\");\n        case 4:\n          _context4.t0 = _regeneratorRuntime().keys(allManifest);\n        case 5:\n          if ((_context4.t1 = _context4.t0()).done) {\n            _context4.next = 11;\n            break;\n          }\n          componentName = _context4.t1.value;\n          _context4.next = 9;\n          return idbSet(\"\".concat(loadedVersion, \"__\").concat(componentName), allManifest[componentName], manifestStore);\n        case 9:\n          _context4.next = 5;\n          break;\n        case 11:\n          setTimeout( /*#__PURE__*/_asyncToGenerator( /*#__PURE__*/_regeneratorRuntime().mark(function _callee3() {\n            var keysInCache, delCount, _iterator, _step, key;\n            return _regeneratorRuntime().wrap(function _callee3$(_context3) {\n              while (1) switch (_context3.prev = _context3.next) {\n                case 0:\n                  _context3.next = 2;\n                  return idbKeys(manifestStore);\n                case 2:\n                  keysInCache = _context3.sent;\n                  delCount = 0;\n                  _iterator = _createForOfIteratorHelper(keysInCache);\n                  _context3.prev = 5;\n                  _iterator.s();\n                case 7:\n                  if ((_step = _iterator.n()).done) {\n                    _context3.next = 16;\n                    break;\n                  }\n                  key = _step.value;\n                  if (!key.startsWith(loadedVersion)) {\n                    _context3.next = 11;\n                    break;\n                  }\n                  return _context3.abrupt(\"continue\", 14);\n                case 11:\n                  _context3.next = 13;\n                  return idbDel(key, manifestStore);\n                case 13:\n                  delCount++;\n                case 14:\n                  _context3.next = 7;\n                  break;\n                case 16:\n                  _context3.next = 21;\n                  break;\n                case 18:\n                  _context3.prev = 18;\n                  _context3.t0 = _context3[\"catch\"](5);\n                  _iterator.e(_context3.t0);\n                case 21:\n                  _context3.prev = 21;\n                  _iterator.f();\n                  return _context3.finish(21);\n                case 24:\n                  delCount && vlog(\"pruned \".concat(delCount, \" old manifest tables\"));\n                case 25:\n                case \"end\":\n                  return _context3.stop();\n              }\n            }, _callee3, null, [[5, 18, 21, 24]]);\n          })), 2000);\n          return _context4.abrupt(\"return\", true);\n        case 13:\n        case \"end\":\n          return _context4.stop();\n      }\n    }, _callee4);\n  }));\n  return _save.apply(this, arguments);\n}","map":{"version":3,"names":["allManifest","compareVersionNumbers","loadedVersion","loadManifestFromApiWithoutCheckingCache","vlog","isVerbose","getDef","getAllDefs","setApiKey","setLanguage","includeTables","excludeTables","verbose","defLanguages","createStore","get","idbGet","keys","idbKeys","set","idbSet","del","idbDel","manifestStore","getLatestCachedVersion","_x","_getLatestCachedVersion","apply","arguments","_asyncToGenerator","_regeneratorRuntime","mark","_callee","lang","_a","sep","keysInCache","manifestsByVersion","wrap","_callee$","_context","prev","next","concat","sent","filter","p","includes","sort","abrupt","split","stop","loadDefs","_loadDefs","_callee2","_callee2$","_context2","console","time","params","version","language","tableName","timeEnd","save","_save","_callee4","componentName","_callee4$","_context4","error","t0","t1","done","value","setTimeout","_callee3","delCount","_iterator","_step","key","_callee3$","_context3","_createForOfIteratorHelper","s","n","startsWith","e","f","finish"],"sources":["C:/Users/jorla/Documents/d2rotations/my-app/node_modules/@d2api/manifest-web/index.js"],"sourcesContent":["import { allManifest, compareVersionNumbers, loadedVersion, loadManifestFromApiWithoutCheckingCache, vlog, isVerbose, } from '@d2api/manifest';\r\nexport { getDef, getAllDefs, setApiKey, setLanguage, allManifest, includeTables, excludeTables, verbose, defLanguages, } from '@d2api/manifest';\r\nexport * from '@d2api/manifest/generated-funcs.js';\r\nimport { createStore, get as idbGet, keys as idbKeys, set as idbSet, del as idbDel } from 'idb-keyval';\r\nconst manifestStore = createStore('manifestDb', 'manifestStore');\r\n/**\r\n * check keys in indexeddb, find the highest numbered one\r\n */\r\nexport async function getLatestCachedVersion(lang) {\r\n    var _a;\r\n    const sep = `__${lang}__`;\r\n    const keysInCache = await idbKeys(manifestStore);\r\n    const manifestsByVersion = keysInCache.filter((p) => p.includes(sep)).sort(compareVersionNumbers);\r\n    return ((_a = manifestsByVersion[0]) === null || _a === void 0 ? void 0 : _a.split(sep)[0]) || '';\r\n}\r\n/**\r\n * loads the newest manifest according to what version the API advertises\r\n *\r\n * if the newest version is already cached locally, uses that. otherwise\r\n * downloads the manifest file from the internet\r\n */\r\nexport async function loadDefs() {\r\n    isVerbose && console.time('manifest loaded');\r\n    await loadManifestFromApiWithoutCheckingCache((params) => idbGet(`${params.version}__${params.language}__${params.tableName}`, manifestStore));\r\n    isVerbose && console.timeEnd('manifest loaded');\r\n    // save the results for next time\r\n    save();\r\n}\r\n/**\r\n * saves the loaded manifest to indexeddb file\r\n */\r\nasync function save() {\r\n    vlog(`saving manifest to indexeddb`);\r\n    if (!allManifest) {\r\n        console.error(`tried to save manifest but none was loaded in memory?`);\r\n        return;\r\n    }\r\n    for (const componentName in allManifest) {\r\n        await idbSet(`${loadedVersion}__${componentName}`, allManifest[componentName], manifestStore);\r\n    }\r\n    setTimeout(async () => {\r\n        const keysInCache = await idbKeys(manifestStore);\r\n        let delCount = 0;\r\n        for (const key of keysInCache) {\r\n            if (key.startsWith(loadedVersion))\r\n                continue;\r\n            await idbDel(key, manifestStore);\r\n            delCount++;\r\n        }\r\n        delCount && vlog(`pruned ${delCount} old manifest tables`);\r\n    }, 2000);\r\n    return true;\r\n}\r\n"],"mappings":"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"},"metadata":{},"sourceType":"module","externalDependencies":[]}